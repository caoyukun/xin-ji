<script setup>
import { ref } from 'vue'

const split1 = ref(0.8)
const split2 = ref(0.25)

const customToolBar = ref(['bold', 'italic'])

const noteList = [
  {
    id: '100',
    content: 'ç»„ä»¶æ€»è§ˆ'
  },
  {
    id: '200',
    content: 'ä½¿ç”¨æŒ‡å—'
  },
  {
    id: '201',
    content: 'æ›´æ–°æ—¥å¿—'
  },
  { id: '202', content: 'ç¯å¢ƒå‡†å¤‡' },
  { id: '203', content: 'å®‰è£…' },
  {
    id: '204',
    content: 'å¼•å…¥ç»„ä»¶'
  },
  { id: '20401', content: 'æŒ‰éœ€å¼•å…¥' },
  { id: '20402', content: 'å®Œæ•´å¼•å…¥' },
  { id: '205', content: 'å¼€å‘ç¤ºä¾‹' },
  { id: '206', content: 'å›½é™…åŒ–' },
  { id: '207', content: 'ä¸»é¢˜é…ç½®' },
  { id: '208', content: 'è¡¨å•æ ¡éªŒé…ç½®' },
  { id: '209', content: 'å¸¸è§é—®é¢˜' },
  {
    id: '300',
    content: 'æ¡†æ¶é£æ ¼'
  },
  {
    id: '301',
    content: 'Color è‰²å½©'
  },
  { id: '302', content: 'Container ç‰ˆå‹' },
  { id: '303', content: 'Font å­—ä½“' },
  { id: '304', content: 'Icon å›¾æ ‡' },
  { id: '305', content: 'Layout å¸ƒå±€' },
  {
    id: '400',
    content: 'å¯¼èˆªç»„ä»¶'
  },
  {
    id: '401',
    content: 'Anchor é”šç‚¹'
  },
  { id: '402', content: 'Guide å¼•å¯¼' },
  { id: '403', content: 'Breadcrumb é¢åŒ…å±‘' },
  {
    id: '500',
    content: 'å®¹å™¨ç»„ä»¶'
  },
  {
    id: '501',
    content: 'Carousel èµ°é©¬ç¯'
  },
  { id: '502', content: 'Collapse æŠ˜å é¢æ¿' },
  { id: '503', content: 'DialogBox å¯¹è¯æ¡†' },
  {
    id: '600',
    content: 'è¡¨å•ç»„ä»¶'
  },
  {
    id: '60101',
    content: 'Button æŒ‰é’®'
  },
  {
    id: '60102',
    content: 'DatePicker æ—¥æœŸé€‰æ‹©å™¨'
  },
  {
    id: '60103',
    content: 'Select é€‰æ‹©å™¨'
  },
  {
    id: '60104',
    content: 'DropTimes ä¸‹æ‹‰æ—¶é—´'
  },
  {
    id: '60105',
    content: 'Input è¾“å…¥æ¡†'
  },
  {
    id: '700',
    content: 'ä¸šåŠ¡ç»„ä»¶'
  },
  {
    id: '701',
    content: 'Amount é‡‘é¢'
  },
  { id: '702', content: 'Area ç‰‡åŒº' },
  { id: '703', content: 'Company å…¬å¸' },
  {
    id: '800',
    content: 'å…¶ä»–ç»„ä»¶'
  },
  {
    id: '801',
    content: 'åºŸå¼ƒç»„ä»¶'
  },
  {
    id: '80101',
    content: 'CreditCardForm ä¿¡ç”¨å¡è¡¨å•'
  },
  {
    id: '80102',
    content: 'DetailPage è¡¨å¤´è¯¦æƒ…æ '
  },
  {
    id: '802',
    content: 'æ–°å¢ç»„ä»¶'
  },
  {
    id: '80201',
    content: 'QrCode äºŒç»´ç '
  },
  {
    id: '80202',
    content: 'Watermark æ°´å°'
  },
  {
    id: '80203',
    content: 'MindMap è„‘å›¾',
  },
  {
    id: '80204',
    content: 'Skeleton éª¨æ¶å±'
  },
  {
    id: '803',
    content: 'BulletinBoard å…¬å‘Šç‰Œ'
  },
  { id: '804', content: 'Calendar æ—¥å†' }
]

const noteMap = new Map(noteList.map(item => [item.id, item]));

const noteTree = [
  {
    id: '100',
    title: 'ç»„ä»¶æ€»è§ˆ'
  },
  {
    id: '200',
    title: 'ä½¿ç”¨æŒ‡å—',
    children: [
      {
        id: '201',
        title: 'æ›´æ–°æ—¥å¿—'
      },
      { id: '202', title: 'ç¯å¢ƒå‡†å¤‡' },
      { id: '203', title: 'å®‰è£…' },
      {
        id: '204',
        title: 'å¼•å…¥ç»„ä»¶',
        children: [
          { id: '20401', title: 'æŒ‰éœ€å¼•å…¥' },
          { id: '20402', title: 'å®Œæ•´å¼•å…¥' }
        ]
      },
      { id: '205', title: 'å¼€å‘ç¤ºä¾‹' },
      { id: '206', title: 'å›½é™…åŒ–' },
      { id: '207', title: 'ä¸»é¢˜é…ç½®' },
      { id: '208', title: 'è¡¨å•æ ¡éªŒé…ç½®' },
      { id: '209', title: 'å¸¸è§é—®é¢˜' }
    ]
  },
  {
    id: '300',
    title: 'æ¡†æ¶é£æ ¼',
    children: [
      {
        id: '301',
        title: 'Color è‰²å½©'
      },
      { id: '302', title: 'Container ç‰ˆå‹' },
      { id: '303', title: 'Font å­—ä½“' },
      { id: '304', title: 'Icon å›¾æ ‡' },
      { id: '305', title: 'Layout å¸ƒå±€' }
    ]
  },
  {
    id: '400',
    title: 'å¯¼èˆªç»„ä»¶',
    children: [
      {
        id: '401',
        title: 'Anchor é”šç‚¹'
      },
      { id: '402', title: 'Guide å¼•å¯¼' },
      { id: '403', title: 'Breadcrumb é¢åŒ…å±‘' }
    ]
  },
  {
    id: '500',
    title: 'å®¹å™¨ç»„ä»¶',
    children: [
      {
        id: '501',
        title: 'Carousel èµ°é©¬ç¯'
      },
      { id: '502', title: 'Collapse æŠ˜å é¢æ¿' },
      { id: '503', title: 'DialogBox å¯¹è¯æ¡†' }
    ]
  },
  {
    id: '600',
    title: 'è¡¨å•ç»„ä»¶',
    children: [
      {
        id: '60101',
        title: 'Button æŒ‰é’®'
      },
      {
        id: '60102',
        title: 'DatePicker æ—¥æœŸé€‰æ‹©å™¨'
      },
      {
        id: '60103',
        title: 'Select é€‰æ‹©å™¨'
      },
      {
        id: '60104',
        title: 'DropTimes ä¸‹æ‹‰æ—¶é—´'
      },
      {
        id: '60105',
        title: 'Input è¾“å…¥æ¡†'
      }
    ]
  },
  {
    id: '700',
    title: 'ä¸šåŠ¡ç»„ä»¶',
    children: [
      {
        id: '701',
        title: 'Amount é‡‘é¢'
      },
      { id: '702', title: 'Area ç‰‡åŒº' },
      { id: '703', title: 'Company å…¬å¸' }
    ]
  },
  {
    id: '800',
    title: 'å…¶ä»–ç»„ä»¶',
    children: [
      {
        id: '801',
        title: 'åºŸå¼ƒç»„ä»¶',
        children: [
          {
            id: '80101',
            title: 'CreditCardForm ä¿¡ç”¨å¡è¡¨å•'
          },
          {
            id: '80102',
            title: 'DetailPage è¡¨å¤´è¯¦æƒ…æ '
          }
        ]
      },
      {
        id: '802',
        title: 'æ–°å¢ç»„ä»¶',
        children: [
          {
            id: '80201',
            title: 'QrCode äºŒç»´ç ',
          },
          {
            id: '80202',
            title: 'Watermark æ°´å°'
          },
          {
            id: '80203',
            title: 'MindMap è„‘å›¾'
          },
          {
            id: '80204',
            title: 'Skeleton éª¨æ¶å±'
          }
        ]
      },
      {
        id: '803',
        title: 'BulletinBoard å…¬å‘Šç‰Œ'
      },
      { id: '804', title: 'Calendar æ—¥å†' }
    ]
  }
];

function addTreePath(node, path, nodePathMap) {
  nodePathMap.set('' + node.id, path + '.' + node.id);
  if (node.children) {
    for (let i = 0; i < node.children.length; i++) {
      addTreePath(node.children[i], nodePathMap.get('' + node.id), nodePathMap);
    }
  }
}

function buildTreePath(nodeArray) {
  const nodePathMap = new Map();
  for (let i = 0; i < nodeArray.length; i++) {
    addTreePath(nodeArray[i], '', nodePathMap);
  }
  return nodePathMap;
}

const treePathMap = buildTreePath(noteTree);

function convertNoteTreeObj2TreeMenuObj(noteTreeObj) {
  return  {
    id: noteTreeObj.id,
    label: noteTreeObj.title,
    children: noteTreeObj.children ? noteTreeObj.children.map(item => convertNoteTreeObj2TreeMenuObj(item)) : []
  }
}

const getMenuDataSync = () => {
  return noteTree.map(item => convertNoteTreeObj2TreeMenuObj(item));
}

const treeData = getMenuDataSync();

const value = ref('');

const treeDataRef = ref(treeData)

const activeName = ref('mindmap')

const mindMapOptions = ref({
  'draggable': true,
  'toolBar': true
})

const mindMapData = ref({
  'nodeData': {
    'id': 'c9ee6647385c42de',
    'topic': '',
    'root': true,
    'children': []
  }
});

const treeMenu = ref(null);

const treeMenuKey = ref(0);


// function handleMenuClick(node, childrenConfig) {
//   console.log(data)
// }


const handleNodeClick = (data) => {
  const rootData = treeData.find(t => t.id === (data.id.charAt(0) + '00'));
  mindMapData.value.nodeData.topic = rootData.label;
  mindMapData.value.nodeData.children = rootData.children.map(t => convertTreeMenuData2MindMapData(t));
}

function convertTreeMenuData2MindMapData(treeData) {
  const mindMapData = {
    'id': treeData.id,
    'topic': treeData.label
  }
  if (treeData.children) {
    mindMapData.children = treeData.children.map(t => convertTreeMenuData2MindMapData(t))
  }
  return mindMapData;
}

function onOperation(operation) {
  const info = operation.info;
  const obj = info.obj;
  const toObj = info.toObj;
  const toIndex = toObj.children.findIndex(item => item.id === obj.id);

  const nodePath = treePathMap.get(obj.id).split('.');
  const toNodePath = treePathMap.get(toObj.id).split('.');

  let treeDataArray = treeData;
  for (let i = 1; i < nodePath.length - 1; i++) {
      treeDataArray = treeDataArray.find(item => item.id === nodePath[i]).children;
  }
  const noteTreeObj = treeDataArray.find(item => item.id === obj.id);
  if (!noteTreeObj) {
    return;
  }

  treeDataArray.splice(treeDataArray.findIndex(item => item.id === nodePath.pop()), 1);

  let noteTreeToObj;
  treeDataArray = treeData;
  for (let i = 1; i < toNodePath.length; i++) {
    noteTreeToObj = treeDataArray.find(item => item.id === toNodePath[i]);
    treeDataArray = noteTreeToObj.children;
  }

  treePathMap.set(noteTreeObj.id,treePathMap.get(noteTreeToObj.id) + '.' + noteTreeObj.id);

  if (!noteTreeToObj.children) {
    noteTreeToObj.children = [];
  }

  noteTreeToObj.children.splice(toIndex, 0, noteTreeObj);
  treeMenu.value.$forceUpdate();
  treeMenuKey.value = treeMenuKey.value + 1;
}

</script>

<template>
  <tiny-container pattern="simple" aside-width="0">
    <div class="split-nest">
      <tiny-split v-model="split1" trigger-simple collapse-right-bottom three-areas>
        <template #left>
          <tiny-split v-model="split2" trigger-simple collapse-left-top three-areas>
            <template #left>
              <div class="split-sidebar">
                <tiny-tree ref="treeMenu" :key="treeMenuKey" class="tree-menu" :data="treeDataRef" draggable
                  @node-click="handleNodeClick"></tiny-tree>
              </div>
            </template>
            <template #right>
              <tiny-rich-text-editor v-model="value" :customToolBar="customToolBar"></tiny-rich-text-editor>
            </template>
          </tiny-split>
        </template>
        <template #right>
          <div class="split-content">
            <tiny-mind-map class="demo-mind-map-export-date" ref="mindmap" v-model="mindMapData" :options="mindMapOptions" @operation="onOperation" />
          </div>
          <!-- <tiny-tabs class="xj-tabs" v-model="activeName" position="right">
              <tiny-tab-item title="ğŸ§ " name="mindmap">
                <div class="split-content">
                  <tiny-mind-map class="demo-mind-map-export-date" ref="mindmap" v-model="mindMapData" />
                </div>
              </tiny-tab-item>
              <tiny-tab-item title="ğŸ·ï¸" name="tip">
                æ ‡ç­¾ç®¡ç†
              </tiny-tab-item>
            </tiny-tabs> -->
        </template>
      </tiny-split>
    </div>
  </tiny-container>
</template>

<style scoped>
.tree-menu {
  width: 100%;
}

.split-sidebar {
  display: block;
}

.split-nest {
  height: 100%;
  border: 1px solid #d9d9d9;
}

.split-content {
  height: 100%;
  width: 100%;
  display: flex;
  position: absolute;
  justify-content: center;
  align-items: center;
}

tiny-tree-menu {
  width: 100%;
}

.tiny-mind-map {
  position: absolute;
  width: 100%;
  height: 100%;
}

.xj-tabs {
  width: 100%;
  height: 100%;
}

.tiny-tabs__content {
  line-height: 1.5;
}
</style>
